name: Run Postgres Transaction Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Initialize Go module and download dependencies
      run: |
        go mod init github.com/test/idle-test
        go get github.com/jackc/pgx/v5/stdlib
    
    - name: Test 1 - Error-Induced Aborted State
      run: bash test_idle_in_transaction_aborted.sh
    
    - name: Test 2 - Timeout-Induced Termination
      run: bash test_idle_in_transaction_timeout.sh
    
    - name: Test 3 - Network Partition
      run: bash test_network_partition.sh
    
    - name: Test 4 - Client Kill with Blocked Query
      run: bash test_client_kill.sh
    
    - name: Test 5 - Client Context Cancellation with Blocked Query
      run: bash test_client_cancel.sh
